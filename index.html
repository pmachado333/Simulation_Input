<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simulation Input Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#005EB8; --brand-600:#005EB8; --brand-700:#084a8e;
      --radius:14px; --gap:16px; --control-h:44px;
      --shadow:0 10px 26px rgba(0,0,0,.22);
      --inset: inset 0 0 0 1px rgba(0,0,0,.03);
      --grid-size:28px;
    }
    :root{
      --ink:#e9eef8; --muted:#a9b6cf;
      --bg:#0e1424; --bg-g1: rgba(53,182,255,.08); --bg-g2: rgba(0,94,184,.10);
      --surface:#121a2d; --surface-2:#18233a;
      --line:#28344c; --grid-color:#0f1730;
      --table-header-grad: linear-gradient(180deg, rgba(0,94,184,.20), rgba(0,94,184,.07));
      --hover-row: rgba(53,182,255,.06);
      --pill-bg: rgba(53,182,255,.14);
      --preview-bg:#0b1222; --preview-fg:#e2e8f0;
      --btn-bg: rgba(255,255,255,.05); --btn-bg-hover: rgba(255,255,255,.09);
      --toggle-track:#16243c; --toggle-thumb:#ffffff; --toggle-icon:#cfe3ff;
      --th-fg:#d9e9ff;
    }
    body[data-theme="light"]{
      --ink:#0b1020; --muted:#5b6473;
      --bg:#f7f9fc; --bg-g1: rgba(0,94,184,.06); --bg-g2: rgba(53,182,255,.06);
      --surface:#ffffff; --surface-2:#f8fbff;
      --line:#e6e8ee; --grid-color:#e9eef8;
      --table-header-grad: linear-gradient(180deg, #eef5ff, #f6faff);
      --hover-row:#f3f8ff;
      --pill-bg:#eaf3ff;
      --preview-bg:#ffffff; --preview-fg:#1f2937;
      --btn-bg:#ffffff; --btn-bg-hover:#f1f5fb;
      --shadow:0 8px 20px rgba(15, 23, 42, .08);
      --inset: inset 0 0 0 1px rgba(0,0,0,.03);
      --th-fg:#1e293b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font:15px/1.5 system-ui, Segoe UI, Arial, sans-serif; background:var(--bg);
      background-image:
        radial-gradient(900px 480px at 85% -10%, var(--bg-g1), transparent 60%),
        radial-gradient(860px 520px at -10% 110%, var(--bg-g2), transparent 60%);
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.08;
      background-image: linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
      background-size: var(--grid-size) var(--grid-size);
    }

    header{
      background:linear-gradient(90deg, var(--brand-700), var(--brand-600));
      color:#fff; padding:14px 22px; box-shadow:0 3px 14px rgba(0,0,0,.2);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{display:flex; flex-direction:column}
    header .title{font-size:24px;font-weight:800;margin:0}
    header .subtitle{margin:2px 0 0 0;opacity:.95}

    .theme-toggle{ display:inline-flex; align-items:center; gap:10px; color:#fff; user-select:none; }
    .switch{
      position:relative; width:58px; height:30px; border-radius:999px;
      background:var(--toggle-track); border:1px solid rgba(255,255,255,.2);
      cursor:pointer; display:inline-flex; align-items:center; padding:0 6px; gap:6px;
    }
    .switch svg{ color: var(--toggle-icon); }
    .thumb{
      position:absolute; top:3px; left:3px; width:24px; height:24px; background:var(--toggle-thumb);
      border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:left .18s ease;
    }
    body[data-theme="light"] .thumb{ left:31px; }

    main{min-height:calc(100vh - 68px); display:grid; place-items:start center; padding:28px;}

    .card{
      width:min(960px,100%); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), var(--surface);
      border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:20px;
    }
    h2{margin:0 0 10px}
    p.desc{color:var(--muted);margin:0 0 16px}

    .control-bar{
      display:grid; gap:24px; margin:12px 0 0;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1fr) minmax(0,1fr);
      align-items:start; width:100%;
    }
    .field{display:flex; flex-direction:column}
    .label{font-weight:750; font-size:.96rem; margin-bottom:6px; white-space:nowrap;}

    .group{
      display:flex; align-items:center; background: var(--surface-2);
      border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow: var(--inset);
      height: 44px;
    }
    .addon,.suffix{
      display:flex; align-items:center; justify-content:center; padding:0 10px; height:100%;
      color:#2156a3; background:#eaf3ff; border-right:1px solid var(--line);
    }
    body:not([data-theme="light"]) .addon,
    body:not([data-theme="light"]) .suffix{ color:#cfe3ff; background:rgba(0,94,184,.14); }
    .suffix{ border-right:0; border-left:1px solid var(--line) }
    .group input{
      flex:1; min-width:0; border:0; outline:none; background:transparent; color:var(--ink);
      height:100%; padding:0 12px;
    }
    .group input::placeholder{color:#7b89a5}
    body[data-theme="light"] .group input::placeholder{color:#94a3b8}
    .group:focus-within{ box-shadow:0 0 0 3px rgba(53,182,255,.2), var(--inset); border-color:rgba(53,182,255,.4); }

    .filename .group,
    .period .group,
    .tolerance .group{ width:100%; }

    .helper{ color:var(--muted); margin-top:8px; line-height:1.6; }
    .period .helper{ width:100%; max-width:none; }

    .auto-map, .min-rate, .field-constraints{
      margin-top:16px; padding:12px; border:1px dashed var(--line); border-radius:12px; background:var(--surface-2);
    }
    .auto-map label, .min-rate label, .field-constraints label{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .auto-map input[type="checkbox"], .min-rate input[type="checkbox"], .field-constraints input[type="checkbox"]{ width:18px; height:18px; }

    .table-wrap{overflow:auto; border:1px solid var(--line); border-radius:12px; background:var(--surface-2); margin-top:10px}
    table{width:100%; border-collapse:collapse}
    th,td{padding:11px 12px; border-bottom:1px solid var(--line)}
    th{background:var(--table-header-grad); text-align:left; color:var(--th-fg);}
    tbody tr:hover{background:var(--hover-row)}
    tbody td input{ width:100%; background:transparent; border:1px solid transparent; border-radius:8px; padding:8px 10px; color:var(--ink);}
    tbody td input:focus{ border-color:rgba(53,182,255,.4); background:rgba(53,182,255,.08); outline:none; }
    body[data-theme="light"] tbody td input:focus{ background:#f0f7ff; }

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{ padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:var(--btn-bg); color:var(--ink); cursor:pointer;
      transition: transform .04s ease, background .15s ease, box-shadow .2s ease; }
    button:hover{ background:var(--btn-bg-hover) }
    button:active{ transform: translateY(1px) }
    button.primary{ background:linear-gradient(90deg, var(--brand-700), var(--brand-600)); border-color:rgba(53,182,255,.4); color:#fff;
      box-shadow:0 6px 16px rgba(0,94,184,.25), inset 0 0 0 1px rgba(255,255,255,.06); }

    pre.preview{ white-space:pre; background:var(--preview-bg); color:var(--preview-fg); padding:14px; border-radius:12px; border:1px solid var(--line);
      overflow:auto; max-height:52vh; box-shadow: var(--inset); }
    .pill{display:inline-block;background:var(--pill-bg); color:#1f3d77; padding:2px 8px; border-radius:999px; font-size:.85rem}
    body:not([data-theme="light"]) .pill{ color:#cfe3ff; }

    @media (max-width: 920px){
      .control-bar{ grid-template-columns: 1fr; width:100%; }
      .filename .group{ width:100%; }
      .period .group{ width:100%; }
      .tolerance .group{ width:100%; }
    }

    /* New merged container */
    .field-management{
      margin-top:16px; padding:12px; border:1px dashed var(--line); border-radius:12px; background:var(--surface-2);
    }
    .field-management .section-title{
      font-weight:800; margin:0 0 6px; font-size:1rem;
    }
    .field-management .section-description{
      margin:0 0 10px; color:var(--muted);
    }
    .field-management .min-rate,
    .field-management .field-constraints{
      margin-top:12px; padding:0; border:none; background:transparent;
    }
    .field-management .min-rate .label,
    .field-management .field-constraints .label{
      margin-bottom:8px;
    }
    /* Triple the space after the shut-in helper before Field Constraints */
    .field-management .min-rate .helper{ margin-bottom:36px; }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand">
      <h1 class="title">Simulation Input Generator</h1>
      <p class="subtitle">Prototype Version</p>
    </div>
    <div class="theme-toggle">
      <span id="themeLabel" aria-live="polite">Light mode</span>
      <button id="themeSwitch" class="switch" role="switch" aria-checked="true" aria-label="Toggle light/dark theme" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12.5 3a8.5 8.5 0 1 0 8 11.1A7.5 7.5 0 1 1 12.5 3z" stroke="currentColor"/>
        </svg>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="4" stroke="currentColor"/>
          <path d="M12 2v3M12 19v3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M2 12h3M19 12h3M4.2 19.8l2.1-2.1M17.7 6.3l2.1-2.1" stroke="currentColor"/>
        </svg>
        <span class="thumb"></span>
      </button>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Simulation Input Form">
      <h2>Configuration</h2>
      <p class="desc">Set filename, coupling period and tolerance, choose mapping mode, then generate your <span class="pill">.ixf</span> file.</p>

      <div class="control-bar">
        <div class="field filename">
          <div class="label">Output filename</div>
          <div class="group">
            <div class="addon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 3h7l5 5v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z" stroke="currentColor"/>
                <path d="M13 3v5h5" stroke="currentColor"/>
              </svg>
            </div>
            <input id="filename" type="text" placeholder="network_run01" aria-describedby="filenameHelp" />
            <div class="suffix">.ixf</div>
          </div>
          <div id="filenameHelp" class="helper">
            Used as <strong>filename.ixf</strong> on download. Letters, numbers, dashes, underscores only.
          </div>
        </div>

        <div class="field period">
          <div class="label">Coupling Period (Days)</div>
          <div class="group">
            <div class="addon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="9" stroke="currentColor"/>
                <path d="M12 7v6l4 2" stroke="currentColor"/>
              </svg>
            </div>
            <input id="couplingPeriod" type="number" min="1" step="1" value="120" inputmode="numeric" pattern="[0-9]*" aria-describedby="periodHelp" />
          </div>
          <div id="periodHelp" class="helper">
            Specifies the minimum time period between two consecutive network solves, starting at (local) time zero for each reservoir interacting with the network
          </div>
        </div>

        <div class="field tolerance">
          <div class="label">Tolerance (%)</div>
          <div class="group">
            <div class="addon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M5 19L19 5" stroke="currentColor"/>
                <circle cx="7" cy="7" r="2.5" stroke="currentColor"/>
                <circle cx="17" cy="17" r="2.5" stroke="currentColor"/>
              </svg>
            </div>
            <input id="tolerancePercent" type="number" min="1" max="15" step="0.1" value="5" inputmode="decimal" aria-describedby="toleranceHelp" />
            <div class="suffix">%</div>
          </div>
          <div id="toleranceHelp" class="helper">
            This option defines the solution tolerance for the networksolver
          </div>
        </div>
      </div>

      <!-- Field Management (merged UI only) -->
      <div class="field-management">
        <div class="section-title">Field Management</div>
        <p class="section-description">
          Define field‑wide rate controls used by IXFM rate‑balance actions.
          Configure a shut‑in threshold for low‑rate producers and optional field ceiling rates (LIQUID, OIL, and/or GAS).
          These settings guide how the network balance respects production limits at both well and field levels.
        </p>

        <!-- Min Rate (title removed by request) -->
        <div class="min-rate">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <label for="minRateEnabled">
              <input id="minRateEnabled" type="checkbox" checked />
              Well Shut‑in Oil Rate
            </label>
            <div class="group" style="max-width:220px;">
              <input id="minRateValue" type="number" min="0" step="1" value="100" inputmode="numeric" aria-describedby="minRateHelp" />
              <div class="suffix">bbl/day</div>
            </div>
          </div>
          <div id="minRateHelp" class="helper">
            If enabled, wells with <strong>OIL_PRODUCTION_RATE</strong> lower than this threshold are shut‑in.
          </div>
        </div>

        <!-- Field Constraints -->
        <div class="field-constraints">
          <div class="label">Field Constraints</div>
          <div class="helper" style="margin-bottom:8px;">
            Select either <strong>Liquid</strong> or <strong>Oil</strong> (or none). Gas is optional and can be combined.
          </div>
          <div style="display:flex; gap:18px; align-items:center; flex-wrap:wrap;">
            <label for="fcLiquidEnabled"><input id="fcLiquidEnabled" type="checkbox" /> Liquid Rate (STB/d)</label>
            <div class="group" style="max-width:220px;">
              <input id="fcLiquidValue" type="number" min="0" step="1" placeholder="RATE VALUE" inputmode="numeric" disabled />
              <div class="suffix">STB/d</div>
            </div>

            <label for="fcOilEnabled" style="margin-left:8px;"><input id="fcOilEnabled" type="checkbox" /> Oil Rate (STB/d)</label>
            <div class="group" style="max-width:220px;">
              <input id="fcOilValue" type="number" min="0" step="1" placeholder="RATE VALUE" inputmode="numeric" disabled />
              <div class="suffix">STB/d</div>
            </div>

            <label for="fcGasEnabled" style="margin-left:8px;"><input id="fcGasEnabled" type="checkbox" /> Gas Rate (MSCF/d)</label>
            <div class="group" style="max-width:220px;">
              <input id="fcGasValue" type="number" min="0" step="1" placeholder="RATE VALUE" inputmode="numeric" disabled />
              <div class="suffix">MSCF/d</div>
            </div>
          </div>
          <div class="helper">
            Set the maximum allowable production rates for the entire field. Selected limits are applied through
            <code>GuideRateBalanceAction "FM_FIELD_OG_LIMIT"</code> and referenced by the
            <code>CombinedNetworkBalanceAction</code>, ensuring total field production does not exceed the specified ceilings.
          </div>
        </div>
      </div>

      <div class="auto-map">
        <label for="autoMap">
          <input id="autoMap" type="checkbox" />
          Automatic Map Boundary Nodes
        </label>
        <p class="helper">
          Automatically map the network boundary wells to the reservoir wells. Should only be used if the Target names is an exactly match to the Well Decline curves name
        </p>
      </div>

      <div class="field" style="margin-top:12px;">
        <div class="label">Boundary Nodes Map</div>
        <p class="helper">
          Assign each <strong>Well Target Name</strong> (from Field Layout Generator) to a <strong>Well Name</strong> (from decline curves).
          Paste directly from Excel (two columns: Target, Well). Pasting starts at the focused cell and auto-adds rows.
        </p>
        <div class="table-wrap">
          <table id="mapTable">
            <thead>
              <tr>
                <th>Well Target Name</th>
                <th>Well Name</th>
                <th style="width:1%)">Actions</th>
              </tr>
            </thead>
            <tbody id="mapBody"></tbody>
          </table>
        </div>
        <div class="controls">
          <button id="addRowBtn" type="button">+ Add Row</button>
          <button id="clearRowsBtn" type="button" class="danger">Clear All</button>
        </div>
      </div>

      <div class="controls" style="margin-top:16px">
        <button id="previewToggleBtn" type="button">Preview</button>
        <button id="generateBtn" type="button" class="primary">Generate .ixf</button>
      </div>

      <div id="previewCard" style="display:none; margin-top:12px;">
        <div class="label" style="margin-bottom:6px">Preview</div>
        <pre class="preview" id="previewBox"></pre>
      </div>
    </section>
  </main>

  <script>
    (function(){
      const body = document.body;
      const btn  = document.getElementById('themeSwitch');
      const label= document.getElementById('themeLabel');
      function setTheme(theme){
        body.setAttribute('data-theme', theme);
        btn.setAttribute('aria-checked', theme === 'light' ? 'true' : 'false');
        label.textContent = theme === 'light' ? 'Light mode' : 'Dark mode';
        try{ localStorage.setItem('ixf_theme', theme); }catch{}
      }
      let init = 'light';
      try{
        const stored = localStorage.getItem('ixf_theme');
        if(stored === 'dark' || stored === 'light'){ init = stored; }
      }catch{}
      setTheme(init);
      btn.addEventListener('click', ()=> setTheme(body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'));
    })();

    function sanitizeFilename(name){ const t=String(name).trim(); const s=t.replace(/[^A-Za-z0-9._-]/g,"_"); return s || "network_config"; }
    function escapeQuoted(str){ return String(str).replace(/\\/g,"\\\\").replace(/"/g,'\\\"'); }

    const mapBody = document.getElementById("mapBody");
    function addRow(target="", well=""){
      const tr=document.createElement("tr");

      const tdTarget=document.createElement("td");
      const inTarget=document.createElement("input");
      inTarget.type="text"; inTarget.placeholder='Well1'; inTarget.value=target;
      inTarget.addEventListener("paste", handleGridPaste);
      inTarget.addEventListener("input", refreshPreviewIfVisible);
      tdTarget.appendChild(inTarget);

      const tdWell=document.createElement("td");
      const inWell=document.createElement("input");
      inWell.type="text"; inWell.placeholder='P1'; inWell.value=well;
      inWell.addEventListener("paste", handleGridPaste);
      inWell.addEventListener("input", refreshPreviewIfVisible);
      tdWell.appendChild(inWell);

      const tdAct=document.createElement("td");
      const del=document.createElement("button");
      del.type="button"; del.className="danger"; del.textContent="Delete";
      del.addEventListener("click", ()=>{ tr.remove(); refreshPreviewIfVisible(); });
      tdAct.appendChild(del);

      tr.append(tdTarget,tdWell,tdAct);
      mapBody.appendChild(tr);
      refreshPreviewIfVisible();
      return tr;
    }
    function ensureRowCount(n){ while(mapBody.rows.length<n) addRow(); }
    function collectRows(){
      const rows=[]; mapBody.querySelectorAll("tr").forEach(tr=>{
        const t=tr.cells[0].querySelector("input").value.trim();
        const w=tr.cells[1].querySelector("input").value.trim();
        if(t && w) rows.push([t,w]);
      }); return rows;
    }
    function parseClipboard(text){ const lines=String(text).replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.length>0); return lines.map(l=>l.split("\t")); }
    function getCellPosition(input){
      const tr=input.closest("tr");
      const rowIndex=Array.from(mapBody.rows).indexOf(tr);
      const cellIndex=Array.from(tr.cells).indexOf(input.closest("td"));
      return {rowIndex,cellIndex};
    }
    function handleGridPaste(e){
      const txt=(e.clipboardData||window.clipboardData).getData("text");
      if(!txt || (!txt.includes("\t") && !txt.includes("\n"))) return;
      e.preventDefault();

      const data=parseClipboard(txt);
      const {rowIndex,cellIndex}=getCellPosition(e.target);

      const needed=rowIndex+data.length; ensureRowCount(needed);

      data.forEach((cols,i)=>{
        const r=mapBody.rows[rowIndex+i];
        const tInput=r.cells[0].querySelector("input");
        const wInput=r.cells[1].querySelector("input");
        const c0=cols[0]??""; const c1=cols[1]??"";
        if(cellIndex===0){ if(c0!=="") tInput.value=c0; if(c1!=="") wInput.value=c1; }
        else { if(c0!=="") wInput.value=c0; }
      });
      refreshPreviewIfVisible();
    }

    const autoMap = document.getElementById('autoMap');
    const addRowBtn = document.getElementById('addRowBtn');
    const clearRowsBtn = document.getElementById('clearRowsBtn');

    function setAutoMapState(enabled){
      if(enabled){ mapBody.innerHTML = ""; }
      addRowBtn.disabled = enabled;
      clearRowsBtn.disabled = enabled;
      refreshPreviewIfVisible();
    }
    autoMap.addEventListener('change', (e)=> setAutoMapState(e.target.checked));

    const minRateEnabledEl = document.getElementById('minRateEnabled');
    const minRateValueEl = document.getElementById('minRateValue');
    function setMinRateState(enabled){
      minRateValueEl.disabled = !enabled;
      refreshPreviewIfVisible();
    }
    minRateEnabledEl.addEventListener('change', (e)=> setMinRateState(e.target.checked));
    minRateValueEl.addEventListener('input', refreshPreviewIfVisible);

    // --- Field Constraints wiring ---
    const fcLiquidEnabled = document.getElementById('fcLiquidEnabled');
    const fcLiquidValue   = document.getElementById('fcLiquidValue');
    const fcOilEnabled    = document.getElementById('fcOilEnabled');
    const fcOilValue      = document.getElementById('fcOilValue');
    const fcGasEnabled    = document.getElementById('fcGasEnabled');
    const fcGasValue      = document.getElementById('fcGasValue');

    function updateFcStates(){
      // enforce mutual exclusivity for Liquid/Oil
      if(fcLiquidEnabled.checked){ fcOilEnabled.checked = false; fcOilValue.disabled = true; }
      if(fcOilEnabled.checked){ fcLiquidEnabled.checked = false; fcLiquidValue.disabled = true; }
      fcLiquidValue.disabled = !fcLiquidEnabled.checked;
      fcOilValue.disabled    = !fcOilEnabled.checked;
      fcGasValue.disabled    = !fcGasEnabled.checked;
      refreshPreviewIfVisible();
    }

    fcLiquidEnabled.addEventListener('change', updateFcStates);
    fcOilEnabled.addEventListener('change', updateFcStates);
    fcGasEnabled.addEventListener('change', updateFcStates);
    fcLiquidValue.addEventListener('input', refreshPreviewIfVisible);
    fcOilValue.addEventListener('input', refreshPreviewIfVisible);
    fcGasValue.addEventListener('input', refreshPreviewIfVisible);

    function buildIXF(){
      const filename=sanitizeFilename(document.getElementById("filename").value);
      const period=parseInt(document.getElementById("couplingPeriod").value,10);
      const tolPctRaw = parseFloat(document.getElementById("tolerancePercent").value);
      const auto = autoMap.checked;

      if(!Number.isFinite(period)||period<1) throw new Error("Coupling Period (Days) must be a positive integer.");
      if(!Number.isFinite(tolPctRaw)||tolPctRaw<1||tolPctRaw>15) throw new Error("Tolerance (%) must be between 1 and 15.");

      const tolFraction = Math.round((tolPctRaw/100) * 1e6) / 1e6;

      const mappings = collectRows();
      if(!auto && mappings.length===0) throw new Error("Add at least one Target \u2194 Well mapping or enable Automatic Map Boundary Nodes.");

      const lines=[];
      lines.push(
        "START","",
        "# ---------------------------------------------------------------------------------------------------",
        "#  Setup actions",
        "# ---------------------------------------------------------------------------------------------------",
        "#  Network balancing action","",
        "CouplingProperties {",
        "  SolutionMethod=PERIODIC",
        "  MinNetworkPeriod="+period,
        "}",
        "",
        "Network {",
        "  VerbosityLevel=5",
        "  NetworkSettings {",
        "    Tolerance="+tolFraction,
        "    MaxIters=50",
        "  }",
        "}",
        "",
        'NetworkBalanceAction "ACT_NET_BAL" {',
        "    VerbosityLevel=5",
        '    DefaultCouplingLocation="BOTTOM_HOLE"'
      );

      if(auto){
        lines.push("    automatically_map_boundary_nodes()");
      }else{
        lines.push("    BoundaryNodesMap=[");
        mappings.forEach(([target,well])=>{
          lines.push(`    NetworkWellBoundary("${escapeQuoted(target)}") Well("${escapeQuoted(well)}")`);
        });
        lines.push("                      ]");
      }

      lines.push(
        '    DefaultWellConstraint="OIL_FLOW_RATE"',
        "    IPRConstraintType=PRESSURE",
        "}",
        ""
      );

      const minRateEnabled = minRateEnabledEl.checked;
      if(minRateEnabled){
        const minRateRaw = parseFloat(minRateValueEl.value);
        if(!Number.isFinite(minRateRaw)) throw new Error("Minimum Well Rate must be a number.");
        const minRate = Math.round(minRateRaw * 1000) / 1000;

        lines.push(
          "# --- pick your shut-in threshold (example uses 100 STB/d) ---",
          'DynamicList "BelowMinOilRate" {',
          '  InitialList    = Group("FM_FIELD")',
          "  EntityLevel    = WELL",
          "  SelectionCriteria = [",
          `   \"(Status == OPEN) & (Type == PRODUCER) & (OIL_PRODUCTION_RATE < ${minRate})\"`,
          "  ]",
          "}",
          "",
          "# Close all wells in the dynamic list above",
          'CloseWellAction "ShutLowRate" {',
          "  WellList = DynamicList('BelowMinOilRate')",
          " # (optional) ClosureReason = ECONOMIC",
          "}",
          "",
          "# Run the close action each timestep (after the step finishes)",
          'Instruction "ShutWellsBelowMinRate" {',
          "  Actions = [ CloseWellAction('ShutLowRate') ]",
          "  ExecutionPosition = END_TIMESTEP",
          "}",
          "",
          "# Add instruction to a strategy (or add to your existing strategy)",
          'Strategy "AutoShutLowRate" {',
          "  Instructions = [ Instruction('ShutWellsBelowMinRate') ]",
          "}",
          ""
        );
      }

      // --- Field Constraints content ---
      const liquidSelected = fcLiquidEnabled.checked;
      const oilSelected    = fcOilEnabled.checked;
      const gasSelected    = fcGasEnabled.checked;

      if(liquidSelected && oilSelected){
        throw new Error("Select either Liquid or Oil (not both) in Field Constraints.");
      }

      const constraints = [];
      function round3(n){ return Math.round(n * 1000) / 1000; }

      if(liquidSelected){
        const v = parseFloat(fcLiquidValue.value);
        if(!Number.isFinite(v)) throw new Error("Enter a numeric value for Liquid Rate.");
        constraints.push(`LIQUID_PRODUCTION_RATE(Group('FM_FIELD')) < ${round3(v)}`);
      }else if(oilSelected){
        const v = parseFloat(fcOilValue.value);
        if(!Number.isFinite(v)) throw new Error("Enter a numeric value for Oil Rate.");
        constraints.push(`OIL_PRODUCTION_RATE(Group('FM_FIELD')) < ${round3(v)}`);
      }
      if(gasSelected){
        const v = parseFloat(fcGasValue.value);
        if(!Number.isFinite(v)) throw new Error("Enter a numeric value for Gas Rate.");
        constraints.push(`GAS_PRODUCTION_RATE(Group('FM_FIELD')) < ${round3(v)}`);
      }

      // --- Setup strategy header ---
      lines.push(
        "# ---------------------------------------------------------------------------------------------------",
        "#  Setup strategy",
        "# ---------------------------------------------------------------------------------------------------"
      );

      // Add GuideRateBalanceAction only if we have constraints
      const hasConstraints = constraints.length > 0;
      if(hasConstraints){
        lines.push(
          'GuideRateBalanceAction "FM_FIELD_OG_LIMIT" {',
          "  Constraints = ["
        );
        constraints.forEach(c => lines.push(`    "${c}"`));
        lines.push(
          "  ]",
          "}",
          ""
        );
      }

      // CombinedNetworkBalanceAction (conditional AllocationActions)
      lines.push(
        "# Strategy: applies the instruction to test all the wells and applies the guide rate balance action",
        'CombinedNetworkBalanceAction "CB_NB" {'
      );
      lines.push('\tNetworkBalanceActions=[ NetworkBalanceAction("ACT_NET_BAL") ]    ');
      if(hasConstraints){
        lines.push('\tAllocationActions=[GuideRateBalanceAction("FM_FIELD_OG_LIMIT")]');
      }
      lines.push(
        "}",
        "",
        'Strategy "STRATEGY_1" {',
        '    BalancingAction=CombinedNetworkBalanceAction("CB_NB")',
        "}"
      );
      return {filename,content:lines.join("\r\n")};
    }

    const previewCard=document.getElementById("previewCard");
    const previewBox=document.getElementById("previewBox");
    const previewToggleBtn=document.getElementById("previewToggleBtn");
    let previewVisible=false;

    function setPreview(visible){
      previewVisible = visible;
      previewCard.style.display = visible ? "block" : "none";
      previewToggleBtn.textContent = visible ? "Hide Preview" : "Preview";
      if (visible){
        try{ const {content}=buildIXF(); previewBox.textContent=content; }catch(err){ previewBox.textContent = "[Error] " + err.message; }
      }
    }
    function refreshPreviewIfVisible(){
      if(!previewVisible) return;
      setPreview(true);
    }

    document.getElementById("couplingPeriod").addEventListener("input", refreshPreviewIfVisible);
    document.getElementById("tolerancePercent").addEventListener("input", refreshPreviewIfVisible);

    document.getElementById("addRowBtn").addEventListener("click", ()=> addRow());
    document.getElementById("clearRowsBtn").addEventListener("click", ()=>{ mapBody.innerHTML=""; refreshPreviewIfVisible(); });
    document.getElementById("generateBtn").addEventListener("click", ()=>{
      try{
        const {filename,content}=buildIXF();
        const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url;
        const safe = filename.endsWith(".ixf")?filename:filename+".ixf";
        a.download=safe; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }catch(err){ alert(err.message); }
    });
    previewToggleBtn.addEventListener("click", ()=> setPreview(!previewVisible));

    [["Well1","P1"],["Well2","P2"],["Well3","P3"]].forEach(([t,w])=>addRow(t,w));

    setAutoMapState(autoMap.checked);
    setMinRateState(minRateEnabledEl.checked);
    updateFcStates();
  </script>
</body>
</html>
